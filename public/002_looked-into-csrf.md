---
title: CSRF Tokenについて調べてみた
tags:
  - Security
  - Web
  - csrf
  - token
private: false
updated_at: '2024-01-14T21:27:09+09:00'
id: 7ac720cbb9966b9ea912
organization_url_name: null
slide: false
ignorePublish: false
---
# CSRF Tokenについて調べてみた

# CSRF Token とは

![01_mind-map.png](https://github.com/semba-yui/qiita-content/blob/main/image/002_looked-into-csrf/01_mind-map.png?raw=trueg)

CSRF(XSRF) Token とは、CSRF（Cross-Site Request Forgery）攻撃を防ぐための Token です。
CSRF Token を知るために、まず CSRF 攻撃とはなにかに付いて知る必要があります。

# CSRF 攻撃とは

CSRF攻撃は、ユーザーが信頼しているサイトに対して、
意図しないアクション（例えば、パスワード変更、メールアドレス変更など）を強制的に行わせる攻撃です。

## CSRF 攻撃の成立条件

- セッション管理にCookieを使用するアプリに認証されたユーザーがログインしている状態
  - 例) ユーザーが攻撃時にTwitterにログインしていること
- 状態を変更する偽造リクエストの作成が可能
  - フォーム送信や重要なリクエストに対してCSRFトークンを使用していない、または不適切に実装している場合
  - セッションIDが予測可能である、またはセッションが適切に無効化されない場合
- クロスサイトリクエストの許可
  - 他のドメインからのリクエストを適切に制限または検証していない場合

## X(Twitter) で CSRF 攻撃を行う場合

### 1. ユーザーの誘導

攻撃者は、このリンクを電子メール、ソーシャルメディア、フォーラムなどを通じてターゲットに送ります。
リンクは無害に見えますが、バックグラウンドでCSRF攻撃を実行する URL が含まれています。

### 2. 攻撃の実行

ターゲットがリンクをクリックすると、攻撃者が用意した URL が呼び出されます。
この時点で、ターゲットが X にログインしていれば、
そのセッションを利用して、ターゲットのアカウントで無許可のアクション
（例えば、特定のアカウントをフォローする、特定のツイートをリツイートするなど）が行われます。

# CSRFトークンの役割

CSRFトークンは、この種の攻撃を防ぐために使用されます。
サーバーはフォームやリクエストに対して一意のトークンを生成し、
ユーザーがそのフォームを送信する際にこのトークンも一緒に送信されることを要求します。

## リクエストの正当性の確認

CSRFトークンは、ユーザーからのリクエストが正当であることを確認するために使用されます。
サーバーはフォームやAJAXリクエストに対して一意のトークンを生成し、クライアントがそのトークンを送信することを要求します。

## 攻撃者による予測の防止

トークンはランダムに生成されるため、攻撃者が予測することは非常に困難です。
これにより、攻撃者が偽のリクエストを作成することが防がれます。

## セッションとの結びつき

CSRFトークンは通常、ユーザーのセッションに紐付けられています。
これにより、ユーザーごとに異なるトークンが生成され、セキュリティが強化されます。

# CSRFトークンの発行

# トークンの検証
サーバーは受け取ったリクエストに含まれるトークンを検証し、それが有効であることを確認します。
これにより、リクエストが正当なものであるかどうかを判断します。

# セキュリティの強化

CSRFトークンは、セッションIDやクッキーだけでは不十分な場合に追加のセキュリティ層として機能します。

# その他の CSRF 攻撃対策

## SameSite Cookie属性

クッキーにSameSite属性を設定することで、クロスサイトのリクエストに対してクッキーを送信しないようにします。


# 参考

- https://kinsta.com/jp/blog/csrf-attack/